{% extends "pc/base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h5 class="mb-0">æ²™ç›’æµ‹è¯•</h5>
    <small class="text-muted">åœ¨æ­¤æµ‹è¯•æ’ä»¶åŠŸèƒ½ï¼Œæ— éœ€çœŸå®æ¶ˆæ¯</small>
</div>

<!-- æµ‹è¯•é…ç½®å’Œç»“æœ -->
<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title">æµ‹è¯•é…ç½®</h6>
                <form id="sandbox-form">
                    <div class="mb-3">
                        <label for="sandbox-message" class="form-label">æ¶ˆæ¯å†…å®¹ <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="sandbox-message" rows="3" placeholder="è¾“å…¥è¦æµ‹è¯•çš„æ¶ˆæ¯å†…å®¹ï¼Œå¦‚ï¼šèœå•ã€ç­¾åˆ°ã€ä»Šæ—¥è¿åŠ¿ç­‰"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="sandbox-user" class="form-label">ç”¨æˆ·ID <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="sandbox-user" placeholder="å¦‚ï¼š987654321" value="987654321">
                    </div>
                    <div class="mb-3">
                        <label for="sandbox-group" class="form-label">ç¾¤ç»„ID <small class="text-muted">(ç§èŠå¯ç•™ç©º)</small></label>
                        <input type="text" class="form-control" id="sandbox-group" placeholder="ç¾¤èŠæ—¶å¡«å†™ï¼Œå¦‚ï¼š123456789" value="">
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-play-circle"></i> å¼€å§‹æµ‹è¯•
                        </button>
                        <button type="button" class="btn btn-secondary" id="sandbox-clear">
                            <i class="bi bi-arrow-clockwise"></i> æ¸…ç©ºç»“æœ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <div id="sandbox-results">
                    <div class="empty-results text-center text-muted py-4">
                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                        <p>å°šæœªè¿›è¡Œæµ‹è¯•ï¼Œè¯·é…ç½®å‚æ•°åç‚¹å‡»"å¼€å§‹æµ‹è¯•"</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// =====================
// æ²™ç›’æµ‹è¯•åŠŸèƒ½ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
// =====================

// HTMLè½¬ä¹‰å‡½æ•°ï¼ˆç…§æŠ„è€ç‰ˆæœ¬ï¼‰
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// è·å–æ¶ˆæ¯ç±»å‹æ˜¾ç¤ºæ–‡æœ¬ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬é€»è¾‘ï¼‰
function getMessageTypeDisplay(messageInfo) {
    if (!messageInfo) return 'æœªçŸ¥';
    
    // å¦‚æœæœ‰æ˜ç¡®çš„æ¶ˆæ¯ç±»å‹ï¼Œç›´æ¥ä½¿ç”¨
    if (messageInfo.message_type) {
        return messageInfo.message_type;
    }
    
    // æ ¹æ®ç¾¤ç»„IDåˆ¤æ–­æ¶ˆæ¯ç±»å‹
    if (messageInfo.group_id && messageInfo.group_id.trim() !== '') {
        return 'ç¾¤èŠæ¶ˆæ¯';
    } else {
        return 'ç§èŠæ¶ˆæ¯';
    }
}

// Markdownæ¸²æŸ“å‡½æ•°ï¼ˆæ”¯æŒå…¨éƒ¨è¯­æ³•ï¼‰
function renderMarkdown(text) {
    if (!text) return '';
    
    let html = text;
    
    // å…ˆå¤„ç†ä»£ç å—ï¼ˆé˜²æ­¢ä»£ç å—å†…å®¹è¢«è§£æï¼‰
    const codeBlocks = [];
    html = html.replace(/```([\s\S]*?)```/g, function(match, code) {
        const index = codeBlocks.length;
        codeBlocks.push(code);
        return `__CODEBLOCK_${index}__`;
    });
    
    // å¤„ç†è¡Œå†…ä»£ç 
    const inlineCodes = [];
    html = html.replace(/`([^`]+)`/g, function(match, code) {
        const index = inlineCodes.length;
        inlineCodes.push(code);
        return `__INLINECODE_${index}__`;
    });
    
    // HTMLè½¬ä¹‰
    html = escapeHtml(html);
    
    // å¤„ç†QQå¤´åƒå›¾ç‰‡æ ¼å¼ï¼š![åç§° #å®½åº¦ #é«˜åº¦](URL)
    html = html.replace(/!\[([^\]]*?)\s*(?:#(\d+)px)?\s*(?:#(\d+)px)?\]\(([^)]+)\)/g, function(match, alt, width, height, url) {
        const w = width || '100';
        const h = height || '100';
        return `<img src="${url}" alt="${alt}" style="width: ${w}px; height: ${h}px; vertical-align: middle; border-radius: 4px;" />`;
    });
    
    // å¤„ç†æ™®é€šå›¾ç‰‡ï¼š![alt](url)
    html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" style="max-width: 200px; border-radius: 4px;" />');
    
    // å¤„ç†é“¾æ¥ï¼š[ğŸ”—æ–‡å­—](URL) æˆ– [æ–‡å­—](URL)
    html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" class="text-decoration-none">$1</a>');
    
    // å¤„ç†@æåŠï¼š<@ç”¨æˆ·ID>
    html = html.replace(/&lt;@(\d+)&gt;/g, '<span class="badge bg-primary">@$1</span>');
    
    // å¤„ç†å¼•ç”¨å—ï¼š> æ–‡å­—
    html = html.replace(/^&gt;\s+(.+)$/gm, '<blockquote class="border-start border-3 border-secondary ps-3 py-2 my-2 bg-light">$1</blockquote>');
    
    // å¤„ç†åˆ†éš”çº¿ï¼ˆå¿…é¡»åœ¨åŠ ç²—æ–œä½“ä¹‹å‰å¤„ç†ï¼Œå…è®¸å‰åæœ‰ç©ºæ ¼ï¼‰
    html = html.replace(/^\s*---\s*$/gm, '<hr />');
    html = html.replace(/^\s*\*\*\*\s*$/gm, '<hr />');
    
    // å¤„ç†æ ‡é¢˜
    html = html.replace(/^######\s+(.+)$/gm, '<h6>$1</h6>');
    html = html.replace(/^#####\s+(.+)$/gm, '<h5>$1</h5>');
    html = html.replace(/^####\s+(.+)$/gm, '<h4>$1</h4>');
    html = html.replace(/^###\s+(.+)$/gm, '<h3>$1</h3>');
    html = html.replace(/^##\s+(.+)$/gm, '<h2>$1</h2>');
    html = html.replace(/^#\s+(.+)$/gm, '<h1>$1</h1>');
    
    // å¤„ç†æ— åºåˆ—è¡¨ï¼š- æˆ– * å¼€å¤´
    html = html.replace(/^[\*\-]\s+(.+)$/gm, '<li>$1</li>');
    html = html.replace(/(<li>.*?<\/li>)/gs, '<ul class="mb-2">$1</ul>');
    
    // å¤„ç†æœ‰åºåˆ—è¡¨ï¼šæ•°å­—. å¼€å¤´
    html = html.replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>');
    
    // å¤„ç†åˆ é™¤çº¿
    html = html.replace(/~~(.*?)~~/g, '<del>$1</del>');
    
    // å¤„ç†åŠ ç²—å’Œæ–œä½“ï¼ˆå…ˆå¤„ç†åŠ ç²—æ–œä½“ï¼Œå†å¤„ç†å•ç‹¬çš„ï¼‰
    html = html.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>');
    html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
    
    // å¤„ç†ä¸‹åˆ’çº¿åŠ ç²—å’Œæ–œä½“
    html = html.replace(/___(.+?)___/g, '<strong><em>$1</em></strong>');
    html = html.replace(/__(.+?)__/g, '<strong>$1</strong>');
    html = html.replace(/_(.+?)_/g, '<em>$1</em>');
    
    // æ¢å¤ä»£ç å—
    codeBlocks.forEach((code, index) => {
        html = html.replace(`__CODEBLOCK_${index}__`, `<pre><code>${code}</code></pre>`);
    });
    
    // æ¢å¤è¡Œå†…ä»£ç 
    inlineCodes.forEach((code, index) => {
        html = html.replace(`__INLINECODE_${index}__`, `<code>${code}</code>`);
    });
    
    // å¤„ç†æ¢è¡Œ
    html = html.replace(/\n/g, '<br>');
    
    // æ¸…ç†hrå‘¨å›´å¤šä½™çš„bræ ‡ç­¾
    html = html.replace(/(<br>\s*)+<hr \/>/g, '<hr />');
    html = html.replace(/<hr \/>(\s*<br>)+/g, '<hr />');
    
    return html;
}

// åˆå§‹åŒ–æ²™ç›’æµ‹è¯•åŠŸèƒ½ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function initSandbox() {
    const sandboxForm = document.getElementById('sandbox-form');
    const sandboxMessage = document.getElementById('sandbox-message');
    const sandboxGroup = document.getElementById('sandbox-group');
    const sandboxUser = document.getElementById('sandbox-user');
    const sandboxResults = document.getElementById('sandbox-results');
    const sandboxClear = document.getElementById('sandbox-clear');
    
    // æ¸…ç©ºç»“æœ
    sandboxClear.addEventListener('click', function() {
        sandboxResults.innerHTML = `
            <div class="empty-results text-center text-muted py-4">
                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                <p>å°šæœªè¿›è¡Œæµ‹è¯•ï¼Œè¯·é…ç½®å‚æ•°åç‚¹å‡»"å¼€å§‹æµ‹è¯•"</p>
            </div>
        `;
    });
    
    // è¡¨å•æäº¤
    sandboxForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const message = sandboxMessage.value.trim();
        const groupId = sandboxGroup.value.trim();
        const userId = sandboxUser.value.trim();
        
        if (!message) {
            alert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹');
            return;
        }
        if (!userId) {
            alert('è¯·è¾“å…¥ç”¨æˆ·ID');
            return;
        }
        // ç¾¤ç»„IDå¯ä»¥ä¸ºç©ºï¼ˆç§èŠæ¨¡å¼ï¼‰
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        sandboxResults.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">æµ‹è¯•ä¸­...</span>
                </div>
                <p class="mt-2 text-muted">æ­£åœ¨å¤„ç†æ¶ˆæ¯ï¼Œè¯·ç¨å€™...</p>
            </div>
        `;
        
        // è·å–token
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        
        if (!token) {
            sandboxResults.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> æœªæ‰¾åˆ°è®¿é—®token
                </div>
            `;
            return;
        }
        
        // å‘é€æµ‹è¯•è¯·æ±‚ï¼ˆç…§æŠ„è€ç‰ˆæœ¬APIè°ƒç”¨ï¼‰
        fetch(`/web/api/sandbox/test?token=${encodeURIComponent(token)}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: message,
                group_id: groupId,
                user_id: userId
            })
        })
        .then(response => response.json())
        .then(data => {
            displaySandboxResults(data);
        })
        .catch(error => {
            console.error('æ²™ç›’æµ‹è¯•é”™è¯¯:', error);
            sandboxResults.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> æµ‹è¯•è¯·æ±‚å¤±è´¥: ${error.message}
                </div>
            `;
        });
    });
}

// æ˜¾ç¤ºæ²™ç›’æµ‹è¯•ç»“æœï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function displaySandboxResults(data) {
    const sandboxResults = document.getElementById('sandbox-results');
    let html; // åœ¨å‡½æ•°å¼€å¤´å£°æ˜htmlå˜é‡
    
    if (data.success) {
        html = '';
        
        // æ˜¾ç¤ºæ¶ˆæ¯ä¿¡æ¯
        if (data.message_info) {
            html += `
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">æµ‹è¯•ä¿¡æ¯</h6>
                        <span class="badge bg-success"><i class="bi bi-check-circle"></i> æµ‹è¯•å®Œæˆï¼æ’ä»¶æ­£å¸¸å“åº”</span>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3"><strong>æ¶ˆæ¯å†…å®¹:</strong> ${escapeHtml(data.message_info.content)}</div>
                            <div class="col-md-3"><strong>ç±»å‹:</strong> ${escapeHtml(getMessageTypeDisplay(data.message_info))}</div>
                            <div class="col-md-3"><strong>ç¾¤ç»„ID:</strong> ${escapeHtml(data.message_info.group_id)}</div>
                            <div class="col-md-3"><strong>ç”¨æˆ·ID:</strong> ${escapeHtml(data.message_info.user_id)}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // æ˜¾ç¤ºå›å¤ç»“æœ
        if (data.replies && data.replies.length > 0) {
            html += `
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">æ’ä»¶å›å¤ (å…±${data.replies.length}æ¡)</h6>
                    </div>
                    <div class="card-body">
            `;
            
            data.replies.forEach((reply, index) => {
                html += `
                    <div class="border rounded p-4 mb-3 bg-light sandbox-markdown">
                        ${reply.content ? renderMarkdown(reply.content) : '<em>(æ— å†…å®¹)</em>'}
                        
                        ${reply.buttons && reply.buttons.content && Array.isArray(reply.buttons.content.rows) ? `
                            <div class="mt-3">
                                <small class="text-muted d-block mb-2">äº¤äº’æŒ‰é’®:</small>
                                ${reply.buttons.content.rows.map(row => {
                                    if (row && row.buttons && Array.isArray(row.buttons)) {
                                        return `<div class="d-flex flex-wrap gap-2 mb-2">
                                            ${row.buttons.map(btn => {
                                                const buttonText = btn.render_data?.label || btn.action?.data || '';
                                                const buttonStyle = btn.render_data?.style || 0;
                                                const actionType = btn.action?.type || 2;
                                                
                                                // æ ¹æ®æ ·å¼è®¾ç½®æŒ‰é’®ç±»
                                                let btnClass = 'btn btn-sm ';
                                                let iconClass = '';
                                                
                                                switch(buttonStyle) {
                                                    case 0: btnClass += 'btn-outline-secondary'; break;
                                                    case 1: btnClass += 'btn-outline-primary'; break;
                                                    case 2: btnClass += 'btn-outline-secondary'; break;
                                                    case 3: btnClass += 'btn-outline-danger'; break;
                                                    case 4: btnClass += 'btn-primary'; break;
                                                    default: btnClass += 'btn-outline-secondary'; break;
                                                }
                                                
                                                // æ ¹æ®åŠ¨ä½œç±»å‹è®¾ç½®å›¾æ ‡
                                                switch(actionType) {
                                                    case 0: iconClass = 'bi bi-box-arrow-up-right'; break; // è·³è½¬
                                                    case 1: iconClass = 'bi bi-arrow-clockwise'; break; // å›è°ƒ
                                                    case 2: iconClass = 'bi bi-cursor-text'; break; // å›è½¦
                                                    default: iconClass = 'bi bi-gear'; break;
                                                }
                                                
                                                return `<button class="${btnClass}" disabled style="cursor: default;">
                                                    <i class="${iconClass}"></i> ${escapeHtml(buttonText)}
                                                </button>`;
                                            }).join('')}
                                        </div>`;
                                    }
                                    return '';
                                }).join('')}
                            </div>
                        ` : ''}
                `;
                
                // æ˜¾ç¤ºåª’ä½“ä¿¡æ¯
                if (reply.media) {
                    html += `
                        <div class="mt-2">
                            <small class="text-muted d-block mb-1">åª’ä½“é™„ä»¶:</small>
                            <span class="badge bg-info">åŒ…å«åª’ä½“æ–‡ä»¶</span>
                        </div>
                    `;
                }
                
                html += `</div>`;
            });
            
            html += `</div></div>`;
        } else {
            html += `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> æ’ä»¶å·²å¤„ç†æ¶ˆæ¯ï¼Œä½†æ²¡æœ‰è¿”å›ä»»ä½•å›å¤å†…å®¹
                </div>
            `;
        }
    } else {
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        html = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> æµ‹è¯•å¤±è´¥: ${escapeHtml(data.error || 'æœªçŸ¥é”™è¯¯')}
            </div>
        `;
        
        // æ˜¾ç¤ºæ¶ˆæ¯ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
        if (data.message_info) {
            html += `
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">æµ‹è¯•ä¿¡æ¯</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3"><strong>æ¶ˆæ¯å†…å®¹:</strong> ${escapeHtml(data.message_info.content)}</div>
                            <div class="col-md-3"><strong>ç±»å‹:</strong> ${escapeHtml(getMessageTypeDisplay(data.message_info))}</div>
                            <div class="col-md-3"><strong>ç¾¤ç»„ID:</strong> ${escapeHtml(data.message_info.group_id)}</div>
                            <div class="col-md-3"><strong>ç”¨æˆ·ID:</strong> ${escapeHtml(data.message_info.user_id)}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
        if (data.traceback) {
            html += `
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">é”™è¯¯è¯¦æƒ…</h6>
                    </div>
                    <div class="card-body">
                        <pre class="text-danger small" style="max-height: 300px; overflow-y: auto;">${escapeHtml(data.traceback)}</pre>
                    </div>
                </div>
            `;
        }
    }
    
    sandboxResults.innerHTML = html;
}

// é¡µé¢åˆå§‹åŒ–ï¼ˆä¼˜åŒ–æ€§èƒ½ï¼Œé¿å…é˜»å¡ï¼‰
document.addEventListener('DOMContentLoaded', function() {
    // ä½¿ç”¨requestIdleCallbackæ¥ä¼˜åŒ–æ€§èƒ½
    if ('requestIdleCallback' in window) {
        requestIdleCallback(function() {
            initSandbox();
        });
    } else {
        // é™çº§åˆ°setTimeout
        setTimeout(function() {
            initSandbox();
        }, 100);
    }
    
    // æ²™ç›’é¡µé¢ä¸éœ€è¦WebSocketè¿æ¥ï¼Œé¿å…æ€§èƒ½å½±å“
    // ä¸è°ƒç”¨ initSocket('sandbox');
});
</script>

<style>
/* æ²™ç›’æµ‹è¯•ä¸“ç”¨æ ·å¼ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬ï¼‰ */
.sandbox-markdown {
    line-height: 1.6;
}

.sandbox-markdown pre {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 12px;
    margin: 8px 0;
    overflow-x: auto;
    font-size: 13px;
}

.sandbox-markdown code {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 3px;
    padding: 2px 6px;
    font-size: 13px;
    color: #e83e8c;
}

.sandbox-markdown pre code {
    background: none;
    border: none;
    padding: 0;
    color: #333;
}

.sandbox-markdown h1, .sandbox-markdown h2, .sandbox-markdown h3,
.sandbox-markdown h4, .sandbox-markdown h5, .sandbox-markdown h6 {
    margin: 16px 0 8px 0;
    font-weight: 600;
    color: #333;
}

.sandbox-markdown h1 { font-size: 24px; }
.sandbox-markdown h2 { font-size: 20px; }
.sandbox-markdown h3 { font-size: 18px; }
.sandbox-markdown h4 { font-size: 16px; }
.sandbox-markdown h5 { font-size: 14px; }
.sandbox-markdown h6 { font-size: 13px; }

.sandbox-markdown ul, .sandbox-markdown ol {
    margin: 8px 0;
    padding-left: 20px;
}

.sandbox-markdown li {
    margin: 4px 0;
}

.sandbox-markdown blockquote {
    margin: 12px 0;
    padding: 8px 12px;
    background-color: #f8f9fa;
    border-left: 3px solid #6c757d;
    color: #666;
    border-radius: 4px;
}

.sandbox-markdown img {
    display: inline-block;
    margin: 4px 2px;
    max-width: 100%;
}

.sandbox-markdown hr {
    display: block;
    height: 1px;
    border: none;
    background-color: #dee2e6;
    margin: 16px 0;
}

.sandbox-markdown del {
    color: #999;
}

.sandbox-markdown a {
    color: #007bff;
    text-decoration: none;
}

.sandbox-markdown a:hover {
    text-decoration: underline;
}

.sandbox-markdown .badge {
    vertical-align: middle;
    margin: 0 2px;
}
</style>
{% endblock %}